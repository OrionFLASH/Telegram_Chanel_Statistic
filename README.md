# Telegram Channel Scanner

## Формулировка задачи и техническое задание

### Задача
Создать программу на Python для сканирования всех каналов и групп Telegram, в которых пользователь является участником или подписчиком. Программа должна собирать полную информацию о каждом канале, включая количество подписчиков, тип канала, описание и другие доступные данные.

### Техническое задание
1. **Сканирование каналов**: Программа должна просканировать все каналы, группы и супергруппы, в которых пользователь является участником
2. **Сбор информации**: Для каждого канала собрать:
   - Название канала
   - ID канала
   - Username (если есть)
   - Тип (канал, группа, супергруппа, гигагруппа)
   - Количество участников/подписчиков
   - Описание канала
   - Публичность (публичный/приватный)
   - Ссылка на канал
   - Флаги канала: верифицирован, мошеннический, фейковый, ограниченный, скрытый
   - Дата создания (если доступна)
   - Связанный канал (если настроен)
   - Темы форума супергруппы (если включены)
   - Дата последнего сообщения (если доступна)
   - Режим медленной отправки (slowmode)
   - Количество онлайн участников (если доступно)
   - Количество непрочитанных сообщений
   - ID закрепленного сообщения
   - ID папки, в которой находится канал
   - Геолокация канала (если установлена)
   - Информация о миграции (если группа была мигрирована)
   - Права пользователя в канале (можно ли просматривать участников, менять информацию, отправлять сообщения и т.д.)
   - Примечание: темы форума загружаются порциями (по умолчанию до 100 тем)
   - Примечание: обработка канала ограничена таймаутом (по умолчанию 100 секунд) для предотвращения зависаний
3. **Сбор информации по личным чатам**:
   - Имя и username
   - Телефон (если доступен)
   - Дата последнего сообщения
   - Последнее текстовое сообщение от вас
   - Последнее текстовое сообщение от собеседника
   - Последнее системное сообщение (текст или тип действия)
   - Тип последнего сообщения (если не было текстовых сообщений)
   - Среднее число сообщений в день/неделю/месяц за последние 3 месяца
   - Общее число сообщений за год и за все время
   - Число сообщений от вас и от собеседника
   - Для выбранных личных чатов (по списку ID): число слов и букв (по собеседнику, по вам, всего)
   - Информация о пользователе: бот, верифицирован, Premium, мошенник, фейк, ограничен
   - О себе (био) - получается через GetFullUserRequest
   - Общих чатов - количество общих чатов с пользователем
   - Взаимный контакт, в контактах
   - Время обработки (в секундах)
   - Обработка личных чатов выполняется параллельно (по умолчанию 32 задачи)
   - Статус обработки (Ок/Таймаут) и сортировка по "Сообщений всего" по убыванию
   - Отдельный таймаут для выбранных личных чатов (по списку ID)
   - Примечание: колонки со словами и буквами отображаются только если в TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS указан хотя бы один ID
   - Примечание: последние сообщения ищутся в первых 2000 сообщениях для оптимизации скорости
3. **Сохранение результатов**: Результаты сохраняются в XLSX формате для удобного просмотра и сортировки в Excel
4. **Логирование**: Подробное логирование всех операций с двумя уровнями детализации
5. **Безопасность**: Использование .env файла для хранения секретных данных (API ключи)

## Подробное описание решения

Программа использует библиотеку **Telethon** для работы с Telegram API. Telethon является современной асинхронной библиотекой, которая не требует запуска серверной части и работает напрямую с Telegram API через MTProto протокол.

### Архитектура программы

Программа состоит из трех основных модулей:

1. **logger_config.py** - модуль настройки логирования
2. **channel_scanner.py** - модуль сканирования каналов и экспорта
3. **main.py** - основной модуль программы

### Процесс работы

1. Загрузка конфигурации из `.env` файла
2. Создание и авторизация клиента Telegram
3. Получение списка всех диалогов пользователя
4. Фильтрация каналов и групп
5. Сбор детальной информации о каждом канале
6. Сохранение результатов в файлы

### Особенности реализации

- **Асинхронная работа**: Использование asyncio для эффективной работы с API
- **Параллельная обработка**: Параллелизм до 32 потоков (настраивается через TELEGRAM_CONCURRENCY)
- **Оптимизация производительности**: Параллельное выполнение запросов, минимизация задержек
- **Обработка ошибок**: Корректная обработка лимитов API (FloodWaitError)
- **Безопасность**: Все секретные данные хранятся в .env файле, который исключен из git
- **Логирование**: Детальное логирование всех операций с указанием класса и функции

## Структура проекта

```
Telegram_Chanel_Statistic/
├── src/                    # Исходный код программы
│   ├── main.py            # Основной модуль программы
│   ├── channel_scanner.py  # Модуль сканирования каналов
│   ├── logger_config.py   # Модуль настройки логирования
│   └── Tests/             # Папка для тестов
├── log/                    # Папка для логов
├── Docs/                   # Дополнительная документация
├── .env                    # Файл с секретными данными (не в git)
├── .env.example            # Пример конфигурации
├── .gitignore             # Игнорируемые файлы
├── requirements.txt       # Зависимости проекта
└── README.md              # Документация проекта
```

## Полный список переменных и функций

### Модуль logger_config.py

#### Функции

**setup_logger(name: str, log_dir: str = "log") -> logging.Logger**
- **Назначение**: Создает и настраивает логгер с двумя уровнями детализации (INFO и DEBUG)
- **Параметры**:
  - `name`: Имя логгера (обычно имя модуля)
  - `log_dir`: Директория для хранения логов (по умолчанию 'log')
- **Возвращает**: Настроенный объект логгера
- **Пример использования**:
```python
logger = setup_logger("my_module")
logger.info("Информационное сообщение")
logger.debug("Отладочное сообщение")
```

**get_logger(name: str) -> logging.Logger**
- **Назначение**: Получает существующий логгер или создает новый
- **Параметры**:
  - `name`: Имя логгера
- **Возвращает**: Объект логгера
- **Пример использования**:
```python
logger = get_logger("my_module")
```

### Модуль channel_scanner.py

#### Класс ChannelScanner

**__init__(self, client: TelegramClient) -> None**
- **Назначение**: Инициализация сканера каналов
- **Параметры**:
  - `client`: Экземпляр TelegramClient для работы с API
- **Пример использования**:
```python
scanner = ChannelScanner(client)
```

**get_channel_info(self, entity: Channel) -> Optional[Dict[str, Any]]**
- **Назначение**: Получает детальную информацию о канале
- **Параметры**:
  - `entity`: Объект канала из Telegram API
- **Возвращает**: Словарь с информацией о канале или None в случае ошибки
- **Пример использования**:
```python
channel_info = await scanner.get_channel_info(channel_entity)
```

**scan_all_channels(self) -> List[Dict[str, Any]]**
- **Назначение**: Сканирует все каналы, группы и супергруппы пользователя
- **Возвращает**: Список словарей с информацией о каждом канале
- **Пример использования**:
```python
channels_data = await scanner.scan_all_channels()
```

**save_to_json(self, filename: str = "channels_data.json") -> None**
- **Назначение**: Сохраняет данные о каналах в JSON файл
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_json("my_channels.json")
```

**save_to_text(self, filename: str = "channels_list.txt") -> None**
- **Назначение**: Сохраняет данные о каналах в текстовый файл для удобного чтения
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_text("my_channels.txt")
```

**save_to_xlsx(self, filename: str = "channels_data.xlsx") -> None**
- **Назначение**: Сохраняет данные о каналах в XLSX файл с удобным форматированием
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_xlsx("my_channels.xlsx")
```

#### Переменные класса

- `self.client: TelegramClient` - клиент для работы с Telegram API
- `self.logger: logging.Logger` - логгер для записи событий
- `self.channels_data: List[Dict[str, Any]]` - список данных о каналах

### Модуль main.py

#### Функции

**load_config() -> Tuple[Optional[str], Optional[str], Optional[str]]**
- **Назначение**: Загружает конфигурацию из файла .env
- **Возвращает**: Кортеж с API_ID, API_HASH и PHONE из конфигурации
- **Пример использования**:
```python
api_id, api_hash, phone = load_config()
```

**authenticate_client(client: TelegramClient, phone: str) -> None**
- **Назначение**: Выполняет аутентификацию клиента Telegram
- **Параметры**:
  - `client`: Экземпляр TelegramClient
  - `phone`: Номер телефона для входа
- **Пример использования**:
```python
await authenticate_client(client, "+79991234567")
```

**main() -> None**
- **Назначение**: Основная функция программы. Выполняет сканирование всех каналов и сохранение результатов
- **Пример использования**:
```python
asyncio.run(main())
```

## Установка и настройка

### Требования

- Python 3.8 или выше
- pip (менеджер пакетов Python)

### Шаги установки

1. **Создание виртуального окружения**:
```bash
cd ~/Desktop/MyProject/Telegram_Chanel_Statistic
python3 -m venv venv
source venv/bin/activate  # Для macOS/Linux
```

2. **Установка зависимостей**:
```bash
pip install -r requirements.txt
```

3. **Получение API ключей Telegram**:
   - Перейдите на https://my.telegram.org/apps
   - Войдите с вашим номером телефона
   - Создайте новое приложение (рекомендованные параметры ниже)
   - **Рекомендуемые параметры формы создания приложения**:
     - **App title**: любое понятное название, например `Telegram channel statistic (PY)`
     - **Short name**: латиница/цифры, 5–32 символа, без пробелов (например `TG_CHAT_STAT`)
     - **URL**: можно оставить пустым (не требуется для работы)
     - **Platform**: `Desktop` (рекомендуется для скриптов) либо `Other`
     - **Description**: кратко, например `Сканер каналов и групп для личной статистики`
   - Скопируйте `api_id` и `api_hash`

4. **Настройка конфигурации**:
   - Скопируйте файл `.env.example` в `.env`:
   ```bash
   cp .env.example .env
   ```
   - Откройте `.env` и заполните данные:
   ```
   TELEGRAM_API_ID=ваш_api_id
   TELEGRAM_API_HASH=ваш_api_hash
   TELEGRAM_PHONE=+79991234567
   TELEGRAM_CONCURRENCY=32
   TELEGRAM_REQUEST_TIMEOUT=60
   TELEGRAM_CHANNEL_TIMEOUT=100
   TELEGRAM_PRIVATE_TIMEOUT=600
   TELEGRAM_PRIVATE_TIMEOUT_IDS=644264893,1876697589,1614687014,282903350,1033649249,627046553
   TELEGRAM_PRIVATE_TEXT_TIMEOUT=2000
   TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS=1876697589
   TELEGRAM_UNSUBSCRIBE_IDS=1088792240
   TELEGRAM_DELETE_PRIVATE_CHAT_IDS=1032900147,938268774,936347670,1045238644,1089290481
   # Таймаут для скачивания фотографий профиля в секундах (по умолчанию 100)
   TELEGRAM_PHOTOS_TIMEOUT=100
   # Большой таймаут для скачивания фотографий профиля в секундах (по умолчанию 300)
   # Используется для пользователей из списка TELEGRAM_PHOTOS_TIMEOUT_IDS
   TELEGRAM_PHOTOS_LONG_TIMEOUT=300
   # Список ID личных чатов для большого таймаута при скачивании фотографий (через запятую)
   # Для этих пользователей будет использован TELEGRAM_PHOTOS_LONG_TIMEOUT
   TELEGRAM_PHOTOS_TIMEOUT_IDS=
   # Таймаут для скачивания историй в секундах (по умолчанию 100)
   TELEGRAM_STORIES_TIMEOUT=100
   # Большой таймаут для скачивания историй в секундах (по умолчанию 300)
   # Используется для пользователей из списка TELEGRAM_STORIES_TIMEOUT_IDS
   TELEGRAM_STORIES_LONG_TIMEOUT=300
   # Список ID личных чатов для большого таймаута при скачивании историй (через запятую)
   # Для этих пользователей будет использован TELEGRAM_STORIES_LONG_TIMEOUT
   TELEGRAM_STORIES_TIMEOUT_IDS=
   ```
   - Номер телефона указывайте в международном формате, как в Telegram
   - `TELEGRAM_CONCURRENCY` задает количество одновременных задач сканирования (по умолчанию 32, можно увеличить до 64 для еще большего ускорения, но следите за ошибками FloodWaitError)
   - `TELEGRAM_REQUEST_TIMEOUT` задает таймаут запроса в секундах (по умолчанию 60)
   - `TELEGRAM_CHANNEL_TIMEOUT` задает таймаут обработки канала/группы в секундах (по умолчанию 100)
   - `TELEGRAM_PRIVATE_TIMEOUT` задает отдельный таймаут для личных чатов (по умолчанию 600)
   - `TELEGRAM_PRIVATE_TIMEOUT_IDS` — список ID личных чатов для отдельного таймаута (через запятую)
   - `TELEGRAM_PRIVATE_TEXT_TIMEOUT` задает таймаут для подсчета слов и букв (по умолчанию 2000)
   - `TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS` — список ID личных чатов для подсчета слов и букв (через запятую)
   - `TELEGRAM_UNSUBSCRIBE_IDS` — список ID каналов/групп для авто-отписки (через запятую)
   - `TELEGRAM_DELETE_PRIVATE_CHAT_IDS` — список ID личных чатов для удаления с очисткой истории у обоих собеседников (через запятую)
   - `TELEGRAM_PHOTOS_TIMEOUT` — таймаут для скачивания фотографий профиля в секундах (по умолчанию 100)
     - Используется для получения списка фотографий и скачивания каждой фотографии
   - `TELEGRAM_PHOTOS_LONG_TIMEOUT` — большой таймаут для скачивания фотографий профиля в секундах (по умолчанию 300)
     - Используется для пользователей из списка `TELEGRAM_PHOTOS_TIMEOUT_IDS`
     - Рекомендуется для пользователей с большим количеством фотографий
   - `TELEGRAM_PHOTOS_TIMEOUT_IDS` — список ID личных чатов для большого таймаута при скачивании фотографий (через запятую)
     - Для этих пользователей будет использован `TELEGRAM_PHOTOS_LONG_TIMEOUT` вместо стандартного таймаута
   - `TELEGRAM_STORIES_TIMEOUT` — таймаут для скачивания историй в секундах (по умолчанию 100)
     - Используется для получения списка историй и скачивания каждой истории (включая видео)
   - `TELEGRAM_STORIES_LONG_TIMEOUT` — большой таймаут для скачивания историй в секундах (по умолчанию 300)
     - Используется для пользователей из списка `TELEGRAM_STORIES_TIMEOUT_IDS`
     - Рекомендуется для пользователей с большим количеством историй
   - `TELEGRAM_STORIES_TIMEOUT_IDS` — список ID личных чатов для большого таймаута при скачивании историй (через запятую)
     - Для этих пользователей будет использован `TELEGRAM_STORIES_LONG_TIMEOUT` вместо стандартного таймаута
     - **ВАЖНО**: Удаление выполняется только после прохождения тройной проверки безопасности:
       1. Список не пустой
       2. ID сущности в списке для удаления
       3. ID в данных чата совпадает с ID сущности
     - **Безопасность**: В методе удаления выполняются дополнительные проверки для предотвращения случайного удаления
     - **Необратимо**: Удаление с `revoke=True` удаляет историю у обоих собеседников и не может быть отменено

## Использование программы

### Запуск программы

```bash
cd ~/Desktop/MyProject/Telegram_Chanel_Statistic
source venv/bin/activate  # Если виртуальное окружение не активировано
python src/main.py
```

### Процесс работы

1. При первом запуске программа запросит код подтверждения, который придет в Telegram
2. Если у вас включена двухфакторная аутентификация, программа запросит пароль
3. После авторизации начнется сканирование всех каналов
4. После сканирования каналов начнется сканирование личных чатов
5. После сканирования личных чатов начнется скачивание всех фотографий профиля
6. Результаты будут сохранены в каталоги:
   - `OUT/channels_data_YYYYMMDD_HHMM.xlsx` - форматированный файл Excel с данными
   - `img/YYYYMMDD_HHMM/` - каталог с фотографиями профиля пользователей
7. В консоли будет выведена итоговая статистика по каналам и личным чатам, включая:
   - Количество каналов, групп, публичных и приватных
   - Общее количество личных чатов и сообщений
   - Статистика по сообщениям за разные периоды (всего, за 365 дней, за 30 дней)
   - Количество ботов, верифицированных и Premium пользователей
   - Количество удаленных чатов (если есть)

### Результаты работы

Программа создает файлы с результатами:

1. **OUT/channels_data_YYYYMMDD_HHMM.xlsx** - XLSX файл с форматированными таблицами и автофильтрами (в каталоге `OUT/`, с таймштампом `YYYYMMDD_HHMM`)
   - **Закрепление панелей**: первая строка (заголовок) и первые 3 колонки (A, B, C) закреплены для удобной навигации при прокрутке
   - Лист **Каналы** — данные по каналам/группам
     - Сортировка по количеству участников (убывание)
     - Колонка **Статус обработки** показывает Ок/Таймаут при долгой обработке
     - Включает расширенную статистику: флаги канала, режим slowmode, количество онлайн, непрочитанные сообщения, геолокация, права пользователя и другие данные
   - Лист **Личные чаты** — статистика по личным чатам
     - Данные сортируются по колонке **Сообщений всего** (убывание)
     - Колонка **Статус обработки** показывает Ок/Таймаут
     - Колонки **Последнее сообщение от вас**, **Последнее сообщение от собеседника**, **Последнее системное сообщение** содержат текст последних сообщений (до 500 символов)
     - Колонка **Тип последнего сообщения** показывает тип, если не было текстовых сообщений
     - Колонка **Удален по списку** показывает статус удаления чата (Да/Нет/Ошибка удаления)
     - Колонки **Слов от вас**, **Слов от собеседника**, **Слов всего**, **Букв от вас**, **Букв от собеседника**, **Букв всего** отображаются только если в TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS указан хотя бы один ID
     - Колонки **Сообщений за последние 365 дней** и **Сообщений за последние 30 дней** показывают точное количество сообщений за указанные периоды
     - Информация "О себе" и "Общих чатов" получается через GetFullUserRequest для более полных данных
     - В консоли выводится итоговая статистика по всем личным чатам после завершения сканирования

2. **img/YYYYMMDD_HHMM/** - Каталог с фотографиями профиля (с таймштампом `YYYYMMDD_HHMM`)
   - Все фотографии профиля из личных чатов скачиваются автоматически
   - Имя файла: `Имя (Username) [ID]_номер.расширение` (номер начинается с 0)
   - Расширение файла определяется автоматически (обычно .jpg, но может быть .png или .webp)
   - Файл **statistics.txt** содержит статистику скачивания:
     - Всего пользователей обработано
     - Пользователей с фотографиями / без фотографий
     - Всего фотографий найдено
     - Успешно скачано / ошибок при скачивании
     - Процент успешности
   - Скачивание выполняется параллельно для ускорения обработки

### Логи

Все логи сохраняются в папке `log/` с именами файлов по шаблону:
- `INFO_telegram_scanner_YYYYMMDD_HHMM.log` - информационные логи
- `DEBUG_telegram_scanner_YYYYMMDD_HHMM.log` - отладочные логи

## История версий

### Версия 1.5.0 (2026-01-17)

**Новый функционал - скачивание историй (stories):**
- Добавлена функция автоматического скачивания всех доступных историй из личных чатов
- Истории сохраняются в каталог `img_history/YYYYMMDD_HHMM/` с таймштампом
- Поддерживается скачивание фото и видео из историй
- Имя файла: `Имя (Username) [ID]_номер.расширение` (номер начинается с 0)
- Расширение файла определяется автоматически (.jpg для фото, .mp4 для видео)
- Скачивание выполняется параллельно для ускорения обработки
- Добавлены параметры конфигурации:
  - `TELEGRAM_STORIES_TIMEOUT` - таймаут для скачивания историй (по умолчанию 100 секунд)
  - `TELEGRAM_STORIES_LONG_TIMEOUT` - большой таймаут для историй (по умолчанию 300 секунд)
  - `TELEGRAM_STORIES_TIMEOUT_IDS` - список ID для большого таймаута
- Добавлена статистика фото и историй в Excel для каждого пользователя:
  - Фото профиля (всего, скачано, ошибок)
  - Истории (всего, скачано, ошибок)
- Создается файл `statistics.txt` в каталоге с историями со статистикой скачивания
- **Примечание**: Истории доступны только если пользователь добавил вас в контакты или истории публичные

**Технические детали:**
- Добавлены функции `load_stories_timeout_value()`, `load_stories_timeout_ids()`, `load_stories_long_timeout_value()` в `main.py`
- Обновлен класс `ChannelScanner` для поддержки скачивания историй через `functions.stories.GetPeerStoriesRequest`
- Добавлен словарь `user_media_stats` для хранения статистики по фото и историям для каждого пользователя
- Статистика автоматически добавляется в Excel при экспорте данных личных чатов

### Версия 1.4.1 (2026-01-16)

**Улучшения конфигурации:**
- Добавлен параметр `TELEGRAM_PHOTOS_LONG_TIMEOUT` для большого таймаута при скачивании фотографий (по умолчанию 300 секунд)
- Добавлен параметр `TELEGRAM_PHOTOS_TIMEOUT_IDS` для указания ID пользователей с большим количеством фотографий
- Для пользователей из списка `TELEGRAM_PHOTOS_TIMEOUT_IDS` используется `TELEGRAM_PHOTOS_LONG_TIMEOUT` вместо стандартного таймаута
- Создан файл `.env.example` с подробными комментариями ко всем параметрам конфигурации
- Все параметры в `.env.example` теперь имеют описания с примерами использования

**Технические детали:**
- Добавлены функции `load_photos_timeout_ids()` и `load_photos_long_timeout_value()` в `main.py`
- Обновлен класс `ChannelScanner` для поддержки индивидуальных таймаутов для разных пользователей
- Улучшена логика выбора таймаута при скачивании фотографий профиля

### Версия 1.4.0 (2026-01-16)

**Новый функционал - скачивание фотографий профиля:**
- Добавлена функция автоматического скачивания всех фотографий профиля из личных чатов
- Фотографии сохраняются в каталог `img/YYYYMMDD_HHMM/` с таймштампом
- Имя файла: `Имя (Username) [ID]_номер.расширение` (номер начинается с 0)
- Расширение файла определяется автоматически (обычно .jpg, но может быть .png или .webp)
- Скачивание выполняется параллельно для ускорения обработки
- Добавлен параметр `TELEGRAM_PHOTOS_TIMEOUT` в .env для настройки таймаута скачивания (по умолчанию 100 секунд)
- Создается файл `statistics.txt` в каталоге с фотографиями со статистикой:
  - Всего пользователей обработано
  - Пользователей с фотографиями / без фотографий
  - Всего фотографий найдено
  - Успешно скачано / ошибок при скачивании
  - Процент успешности
- Скачивание выполняется после сканирования личных чатов автоматически

**Технические улучшения:**
- Параллельная обработка фотографий с использованием Semaphore для контроля нагрузки
- Таймауты для каждого запроса получения и скачивания фотографий
- Обработка ошибок и таймаутов с детальным логированием
- Автоматическое определение расширения файла

### Версия 1.3.9 (2026-01-16)

**Изменения статистики личных чатов:**
- Убраны колонки "Сообщений за 90 дней", "Среднее в день", "Среднее в неделю", "Среднее в месяц"
- Убраны расчеты средних значений
- Добавлена колонка "Сообщений за последние 30 дней"
- Колонка "Сообщений за год" заменена на "Сообщений за последние 365 дней"
- Улучшена точность статистики: теперь используются точные периоды (30 и 365 дней)

**Улучшения вывода статистики:**
- Добавлена итоговая статистика по личным чатам в консоль:
  - Всего личных чатов
  - Всего сообщений
  - Сообщений за последние 365 дней
  - Сообщений за последние 30 дней
  - Сообщений от вас и от собеседников
  - Количество ботов, верифицированных, Premium пользователей
  - Количество удаленных чатов (если есть)
- Исправлен вывод имени файла в логах: теперь показывается реальное имя файла с таймштампом

### Версия 1.3.8 (2026-01-16)

**Улучшения интерфейса Excel:**
- Изменено закрепление панелей в Excel файлах: закреплены первая строка (заголовок) и первые 3 колонки (A, B, C)
- При прокрутке таблицы заголовок и первые 3 колонки остаются видимыми для удобства навигации
- Закрепление установлено на позиции D1

### Версия 1.3.7 (2026-01-16)

**Исправления:**
- Исправлена ошибка при открытии Excel файлов: добавлена очистка недопустимых символов из всех текстовых полей
- Управляющие символы (control characters) теперь автоматически удаляются или заменяются на пробелы
- Все текстовые данные (названия, описания, сообщения, ссылки) очищаются перед записью в Excel
- Функция `_sanitize_text_for_excel` обрабатывает все текстовые поля для совместимости с Excel

**Решенные проблемы:**
- Исправлена ошибка открытия Excel файлов, вызванная недопустимыми символами в текстовых данных
- Улучшена совместимость с различными версиями Excel и LibreOffice Calc

### Версия 1.3.6 (2026-01-16)

**Улучшения безопасности:**
- Добавлена тройная проверка безопасности при удалении личных чатов
- Проверка 1: Список `delete_private_chat_ids` не пустой
- Проверка 2: `entity.id` (реальный ID сущности) в списке для удаления
- Проверка 3: `chat_info.get("id")` совпадает с `entity.id`
- В методе `_delete_private_chat`: дополнительная проверка соответствия `entity.id` и `expected_id`
- В методе `_delete_private_chat`: повторная проверка, что ID в списке `delete_private_chat_ids`
- Добавлено детальное логирование всех проверок для аудита
- Гарантировано, что удалится только чат, явно указанный в списке

**Решенные проблемы:**
- Исключена возможность удаления чата, не указанного в списке
- Исключена возможность удаления чата при несоответствии ID
- Улучшена безопасность критической операции удаления

**Важно:**
- Удаление выполняется только при прохождении всех проверок безопасности
- Все попытки удаления логируются для аудита
- При любой ошибке проверки удаление отменяется

### Версия 1.3.5 (2026-01-16)

**Реализованный функционал:**
- Исправлена критическая ошибка: количество подписчиков не сохранялось в данные канала
- Улучшен метод `_fetch_participants_count` с более надежной проверкой значений (проверка на None и 0)
- Улучшена обработка ошибок при получении количества участников
- Добавлено более детальное логирование для отладки проблем с получением данных

**Решенные проблемы:**
- Исправлена проблема с отображением "Неизвестно" для количества подписчиков
- Улучшена надежность получения количества участников через различные методы API
- Исправлена обработка случаев, когда API возвращает None или 0

### Версия 1.3.4 (2026-01-16)

**Реализованный функционал:**
- Добавлена возможность удаления личных чатов через параметр TELEGRAM_DELETE_PRIVATE_CHAT_IDS
- Удаление выполняется с очисткой истории у обоих собеседников (revoke=True)
- Добавлена колонка "Удален по списку" в Excel для личных чатов
- Удаление выполняется после сбора информации о чате, аналогично отписке от каналов

**Решенные проблемы:**
- Упрощена очистка нежелательных личных чатов
- Информация о чате сохраняется в Excel даже после удаления

**Важно:**
- Удаление истории с revoke=True необратимо и удаляет историю у обоих собеседников
- Перед использованием убедитесь, что указали правильные ID чатов

### Версия 1.3.3 (2026-01-16)

**Реализованный функционал:**
- Добавлен сбор последних сообщений в личных чатах:
  - Последнее текстовое сообщение от вас
  - Последнее текстовое сообщение от собеседника
  - Последнее системное сообщение (текст или тип действия)
  - Тип последнего сообщения (если не было текстовых)
- Оптимизирован поиск последних сообщений (ограничение первыми 2000 сообщениями для ускорения)

**Решенные проблемы:**
- Улучшена информативность отчетов по личным чатам
- Оптимизирована скорость обработки за счет ограничения поиска последних сообщений

**Выявленные слабые места и рекомендации:**
- **iter_messages** - последовательная обработка всех сообщений для подсчета статистики является узким местом для чатов с большим количеством сообщений. Это ограничение API Telegram, оптимизировано за счет ограничения поиска последних сообщений.
- **Обработка больших каналов** - некоторые каналы обрабатываются 30+ секунд, что нормально для каналов с большим количеством участников и данных.
- **Рекомендации по производительности:**
  - Для чатов с очень большим количеством сообщений (>10000) обработка может занять значительное время
  - Параллелизм 32 потока оптимален для большинства случаев
  - При появлении ошибок FloodWaitError рекомендуется уменьшить TELEGRAM_CONCURRENCY до 24 или 16

### Версия 1.3.2 (2026-01-16)

**Реализованный функционал:**
- Оптимизация производительности программы:
  - Увеличен параллелизм по умолчанию с 16 до 32 потоков
  - Уменьшена задержка между запросами (максимум 0.05 сек вместо 0.2)
  - Убраны избыточные задержки после обработки (Semaphore уже контролирует нагрузку)
  - GetFullUserRequest теперь выполняется параллельно с подсчетом сообщений
- Обновлен .env.example с новым значением TELEGRAM_CONCURRENCY=32

**Решенные проблемы:**
- Значительно ускорена обработка каналов и личных чатов (ожидаемое ускорение в 1.5-2 раза)
- Улучшена эффективность использования API за счет параллельного выполнения запросов
- Оптимизировано использование ресурсов за счет удаления избыточных задержек

**Рекомендации:**
- Если появляются ошибки FloodWaitError, уменьшите TELEGRAM_CONCURRENCY до 24 или 16
- Если ошибок нет, можно попробовать увеличить до 48 или 64 для еще большего ускорения

### Версия 1.3.1 (2026-01-16)

**Реализованный функционал:**
- Улучшено получение данных "О себе" и "Общих чатов" для личных чатов через GetFullUserRequest
- Добавлено условное отображение колонок со словами и буквами (только если указаны ID в TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS)
- Удалена колонка "Язык" из личных чатов
- Обновлен список ID в TELEGRAM_PRIVATE_TIMEOUT_IDS

**Решенные проблемы:**
- Исправлено получение информации "О себе" для личных чатов
- Исправлено получение количества общих чатов
- Упрощен интерфейс Excel (удалена неиспользуемая колонка)

### Версия 1.3.0 (2026-01-15)

**Реализованный функционал:**
- Добавлен сбор расширенной статистики по каналам и группам:
  - Флаги канала: верифицирован, мошеннический, фейковый, ограниченный, скрытый
  - Режим медленной отправки (slowmode)
  - Количество онлайн участников
  - Количество непрочитанных сообщений
  - ID закрепленного сообщения
  - ID папки
  - Геолокация канала
  - Информация о миграции группы
  - Права пользователя в канале (11 различных прав)
- Добавлен отдельный таймаут для обработки каналов (`TELEGRAM_CHANNEL_TIMEOUT`, по умолчанию 100 секунд)
- Все новые данные собираются быстро, без долгих запросов, чтобы не превышать таймаут

**Решенные проблемы:**
- Улучшена информативность отчетов по каналам
- Предотвращены зависания при обработке каналов за счет отдельного таймаута

### Версия 1.2.0 (2026-01-15)

**Реализованный функционал:**
- Переход на XlsxWriter для быстрого экспорта в Excel
- Добавлен таймаут обработки каналов и личных чатов
- Добавлены статусы обработки в отчетах
- Сортировка личных чатов по количеству сообщений

**Решенные проблемы:**
- Устранены визуальные "зависания" за счет таймаутов и прогресса

### Версия 1.1.0 (2026-01-14)

**Реализованный функционал:**
- Добавлен экспорт в XLSX с форматированием таблицы
- Обновлены инструкции по настройке ключей и .env
- Добавлен пример .env.example

**Решенные проблемы:**
- Упрощена настройка доступа к Telegram API за счет подробных шагов

### Версия 1.0.0 (2025-01-XX)

**Реализованный функционал:**
- Сканирование всех каналов и групп Telegram
- Сбор детальной информации о каждом канале:
  - Название, ID, username
  - Тип канала (канал, группа, супергруппа)
  - Количество участников/подписчиков
  - Описание канала
  - Публичность
  - Ссылка на канал
- Сохранение результатов в JSON и текстовый формат
- Подробное логирование с двумя уровнями детализации
- Использование .env для хранения секретных данных
- Обработка ошибок и лимитов API

**Решенные проблемы:**
- Настройка корректной работы с Telegram API через Telethon
- Реализация асинхронной работы для эффективного сканирования
- Обработка случаев, когда количество участников недоступно (требуются права администратора)
- Корректная обработка лимитов API (FloodWaitError)
- Настройка логирования с правильным форматом для DEBUG уровня

**Технические детали:**
- Использование библиотеки Telethon 1.34.0
- Экспорт в Excel через XlsxWriter 3.2.0
- Python 3.8+ с поддержкой type hints
- Асинхронное программирование с asyncio
- Структурированное логирование с указанием класса и функции

## Примечания

- Программа работает без запуска серверной части, используя прямые запросы к Telegram API
- Для получения количества участников в некоторых каналах могут потребоваться права администратора
- При большом количестве каналов сканирование может занять продолжительное время
- Сессия Telegram сохраняется автоматически после первого входа, последующие запуски не требуют повторной авторизации

## Лицензия

Проект создан в образовательных целях.
