# Telegram Channel Scanner

## Формулировка задачи и техническое задание

### Задача
Создать программу на Python для сканирования всех каналов и групп Telegram, в которых пользователь является участником или подписчиком. Программа должна собирать полную информацию о каждом канале, включая количество подписчиков, тип канала, описание и другие доступные данные.

### Техническое задание
1. **Сканирование каналов**: Программа должна просканировать все каналы, группы и супергруппы, в которых пользователь является участником
2. **Сбор информации**: Для каждого канала собрать:
   - Название канала
   - ID канала
   - Username (если есть)
   - Тип (канал, группа, супергруппа)
   - Количество участников/подписчиков
   - Описание канала
   - Публичность (публичный/приватный)
   - Ссылка на канал
   - Дата создания (если доступна)
   - Связанный канал (если настроен)
   - Темы форума супергруппы (если включены)
   - Дата последнего сообщения (если доступна)
   - Примечание: темы форума загружаются порциями (по умолчанию до 100 тем)
3. **Сбор информации по личным чатам**:
   - Имя и username
   - Участники чата
   - Дата последнего сообщения
   - Среднее число сообщений в день/неделю/месяц за последние 3 месяца
   - Общее число сообщений за год и за все время
   - Число сообщений от вас и от собеседника
   - Для выбранных личных чатов: число слов и букв (по собеседнику, по вам, всего)
   - Обработка личных чатов выполняется параллельно (по умолчанию 16 задач)
   - Статус обработки (Ок/Таймаут) и сортировка по "Сообщений всего" по убыванию
   - Отдельный таймаут для выбранных личных чатов (по списку ID)
3. **Сохранение результатов**: Результаты сохраняются в XLSX формате для удобного просмотра и сортировки в Excel
4. **Логирование**: Подробное логирование всех операций с двумя уровнями детализации
5. **Безопасность**: Использование .env файла для хранения секретных данных (API ключи)

## Подробное описание решения

Программа использует библиотеку **Telethon** для работы с Telegram API. Telethon является современной асинхронной библиотекой, которая не требует запуска серверной части и работает напрямую с Telegram API через MTProto протокол.

### Архитектура программы

Программа состоит из трех основных модулей:

1. **logger_config.py** - модуль настройки логирования
2. **channel_scanner.py** - модуль сканирования каналов и экспорта
3. **main.py** - основной модуль программы

### Процесс работы

1. Загрузка конфигурации из `.env` файла
2. Создание и авторизация клиента Telegram
3. Получение списка всех диалогов пользователя
4. Фильтрация каналов и групп
5. Сбор детальной информации о каждом канале
6. Сохранение результатов в файлы

### Особенности реализации

- **Асинхронная работа**: Использование asyncio для эффективной работы с API
- **Обработка ошибок**: Корректная обработка лимитов API (FloodWaitError)
- **Безопасность**: Все секретные данные хранятся в .env файле, который исключен из git
- **Логирование**: Детальное логирование всех операций с указанием класса и функции

## Структура проекта

```
Telegram_Chanel_Statistic/
├── src/                    # Исходный код программы
│   ├── main.py            # Основной модуль программы
│   ├── channel_scanner.py  # Модуль сканирования каналов
│   ├── logger_config.py   # Модуль настройки логирования
│   └── Tests/             # Папка для тестов
├── log/                    # Папка для логов
├── Docs/                   # Дополнительная документация
├── .env                    # Файл с секретными данными (не в git)
├── .env.example            # Пример конфигурации
├── .gitignore             # Игнорируемые файлы
├── requirements.txt       # Зависимости проекта
└── README.md              # Документация проекта
```

## Полный список переменных и функций

### Модуль logger_config.py

#### Функции

**setup_logger(name: str, log_dir: str = "log") -> logging.Logger**
- **Назначение**: Создает и настраивает логгер с двумя уровнями детализации (INFO и DEBUG)
- **Параметры**:
  - `name`: Имя логгера (обычно имя модуля)
  - `log_dir`: Директория для хранения логов (по умолчанию 'log')
- **Возвращает**: Настроенный объект логгера
- **Пример использования**:
```python
logger = setup_logger("my_module")
logger.info("Информационное сообщение")
logger.debug("Отладочное сообщение")
```

**get_logger(name: str) -> logging.Logger**
- **Назначение**: Получает существующий логгер или создает новый
- **Параметры**:
  - `name`: Имя логгера
- **Возвращает**: Объект логгера
- **Пример использования**:
```python
logger = get_logger("my_module")
```

### Модуль channel_scanner.py

#### Класс ChannelScanner

**__init__(self, client: TelegramClient) -> None**
- **Назначение**: Инициализация сканера каналов
- **Параметры**:
  - `client`: Экземпляр TelegramClient для работы с API
- **Пример использования**:
```python
scanner = ChannelScanner(client)
```

**get_channel_info(self, entity: Channel) -> Optional[Dict[str, Any]]**
- **Назначение**: Получает детальную информацию о канале
- **Параметры**:
  - `entity`: Объект канала из Telegram API
- **Возвращает**: Словарь с информацией о канале или None в случае ошибки
- **Пример использования**:
```python
channel_info = await scanner.get_channel_info(channel_entity)
```

**scan_all_channels(self) -> List[Dict[str, Any]]**
- **Назначение**: Сканирует все каналы, группы и супергруппы пользователя
- **Возвращает**: Список словарей с информацией о каждом канале
- **Пример использования**:
```python
channels_data = await scanner.scan_all_channels()
```

**save_to_json(self, filename: str = "channels_data.json") -> None**
- **Назначение**: Сохраняет данные о каналах в JSON файл
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_json("my_channels.json")
```

**save_to_text(self, filename: str = "channels_list.txt") -> None**
- **Назначение**: Сохраняет данные о каналах в текстовый файл для удобного чтения
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_text("my_channels.txt")
```

**save_to_xlsx(self, filename: str = "channels_data.xlsx") -> None**
- **Назначение**: Сохраняет данные о каналах в XLSX файл с удобным форматированием
- **Параметры**:
  - `filename`: Имя файла для сохранения
- **Пример использования**:
```python
scanner.save_to_xlsx("my_channels.xlsx")
```

#### Переменные класса

- `self.client: TelegramClient` - клиент для работы с Telegram API
- `self.logger: logging.Logger` - логгер для записи событий
- `self.channels_data: List[Dict[str, Any]]` - список данных о каналах

### Модуль main.py

#### Функции

**load_config() -> Tuple[Optional[str], Optional[str], Optional[str]]**
- **Назначение**: Загружает конфигурацию из файла .env
- **Возвращает**: Кортеж с API_ID, API_HASH и PHONE из конфигурации
- **Пример использования**:
```python
api_id, api_hash, phone = load_config()
```

**authenticate_client(client: TelegramClient, phone: str) -> None**
- **Назначение**: Выполняет аутентификацию клиента Telegram
- **Параметры**:
  - `client`: Экземпляр TelegramClient
  - `phone`: Номер телефона для входа
- **Пример использования**:
```python
await authenticate_client(client, "+79991234567")
```

**main() -> None**
- **Назначение**: Основная функция программы. Выполняет сканирование всех каналов и сохранение результатов
- **Пример использования**:
```python
asyncio.run(main())
```

## Установка и настройка

### Требования

- Python 3.8 или выше
- pip (менеджер пакетов Python)

### Шаги установки

1. **Создание виртуального окружения**:
```bash
cd ~/Desktop/MyProject/Telegram_Chanel_Statistic
python3 -m venv venv
source venv/bin/activate  # Для macOS/Linux
```

2. **Установка зависимостей**:
```bash
pip install -r requirements.txt
```

3. **Получение API ключей Telegram**:
   - Перейдите на https://my.telegram.org/apps
   - Войдите с вашим номером телефона
   - Создайте новое приложение (рекомендованные параметры ниже)
   - **Рекомендуемые параметры формы создания приложения**:
     - **App title**: любое понятное название, например `Telegram channel statistic (PY)`
     - **Short name**: латиница/цифры, 5–32 символа, без пробелов (например `TG_CHAT_STAT`)
     - **URL**: можно оставить пустым (не требуется для работы)
     - **Platform**: `Desktop` (рекомендуется для скриптов) либо `Other`
     - **Description**: кратко, например `Сканер каналов и групп для личной статистики`
   - Скопируйте `api_id` и `api_hash`

4. **Настройка конфигурации**:
   - Скопируйте файл `.env.example` в `.env`:
   ```bash
   cp .env.example .env
   ```
   - Откройте `.env` и заполните данные:
   ```
   TELEGRAM_API_ID=ваш_api_id
   TELEGRAM_API_HASH=ваш_api_hash
   TELEGRAM_PHONE=+79991234567
   TELEGRAM_CONCURRENCY=16
   TELEGRAM_REQUEST_TIMEOUT=60
   TELEGRAM_PRIVATE_TIMEOUT=600
   TELEGRAM_PRIVATE_TIMEOUT_IDS=644264893,1876697589
   TELEGRAM_PRIVATE_TEXT_TIMEOUT=2000
   TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS=1876697589
   TELEGRAM_UNSUBSCRIBE_IDS=1088792240
   ```
   - Номер телефона указывайте в международном формате, как в Telegram
   - `TELEGRAM_CONCURRENCY` задает количество одновременных задач сканирования
   - `TELEGRAM_REQUEST_TIMEOUT` задает таймаут запроса в секундах
   - `TELEGRAM_PRIVATE_TIMEOUT` задает отдельный таймаут для личных чатов
   - `TELEGRAM_PRIVATE_TIMEOUT_IDS` — список ID личных чатов для отдельного таймаута
   - `TELEGRAM_PRIVATE_TEXT_TIMEOUT` задает таймаут для подсчета слов и букв
   - `TELEGRAM_PRIVATE_TEXT_TIMEOUT_IDS` — список ID личных чатов для подсчета слов и букв
   - `TELEGRAM_UNSUBSCRIBE_IDS` — список ID каналов/групп для авто-отписки (через запятую)

## Использование программы

### Запуск программы

```bash
cd ~/Desktop/MyProject/Telegram_Chanel_Statistic
source venv/bin/activate  # Если виртуальное окружение не активировано
python src/main.py
```

### Процесс работы

1. При первом запуске программа запросит код подтверждения, который придет в Telegram
2. Если у вас включена двухфакторная аутентификация, программа запросит пароль
3. После авторизации начнется сканирование всех каналов
4. Результаты будут сохранены в каталог `OUT/` с таймштампом `YYYYMMDD_HHMM`:
   - `OUT/channels_data_YYYYMMDD_HHMM.xlsx` - форматированный файл Excel

### Результаты работы

Программа создает один файл с результатами (в каталоге `OUT/`, с таймштампом `YYYYMMDD_HHMM`):

1. **OUT/channels_data_YYYYMMDD_HHMM.xlsx** - XLSX файл с форматированными таблицами и автофильтрами
   - Лист **Каналы** — данные по каналам/группам
     - Колонка **Статус обработки** показывает Ок/Таймаут при долгой обработке
   - Лист **Личные чаты** — статистика по личным чатам
     - Данные сортируются по колонке **Сообщений всего** (убывание)
     - Колонка **Статус обработки** показывает Ок/Таймаут

### Логи

Все логи сохраняются в папке `log/` с именами файлов по шаблону:
- `INFO_telegram_scanner_YYYYMMDD_HHMM.log` - информационные логи
- `DEBUG_telegram_scanner_YYYYMMDD_HHMM.log` - отладочные логи

## История версий

### Версия 1.2.0 (2026-01-15)

**Реализованный функционал:**
- Переход на XlsxWriter для быстрого экспорта в Excel
- Добавлен таймаут обработки каналов и личных чатов
- Добавлены статусы обработки в отчетах
- Сортировка личных чатов по количеству сообщений

**Решенные проблемы:**
- Устранены визуальные "зависания" за счет таймаутов и прогресса

### Версия 1.1.0 (2026-01-14)

**Реализованный функционал:**
- Добавлен экспорт в XLSX с форматированием таблицы
- Обновлены инструкции по настройке ключей и .env
- Добавлен пример .env.example

**Решенные проблемы:**
- Упрощена настройка доступа к Telegram API за счет подробных шагов

### Версия 1.0.0 (2025-01-XX)

**Реализованный функционал:**
- Сканирование всех каналов и групп Telegram
- Сбор детальной информации о каждом канале:
  - Название, ID, username
  - Тип канала (канал, группа, супергруппа)
  - Количество участников/подписчиков
  - Описание канала
  - Публичность
  - Ссылка на канал
- Сохранение результатов в JSON и текстовый формат
- Подробное логирование с двумя уровнями детализации
- Использование .env для хранения секретных данных
- Обработка ошибок и лимитов API

**Решенные проблемы:**
- Настройка корректной работы с Telegram API через Telethon
- Реализация асинхронной работы для эффективного сканирования
- Обработка случаев, когда количество участников недоступно (требуются права администратора)
- Корректная обработка лимитов API (FloodWaitError)
- Настройка логирования с правильным форматом для DEBUG уровня

**Технические детали:**
- Использование библиотеки Telethon 1.34.0
- Экспорт в Excel через XlsxWriter 3.2.0
- Python 3.8+ с поддержкой type hints
- Асинхронное программирование с asyncio
- Структурированное логирование с указанием класса и функции

## Примечания

- Программа работает без запуска серверной части, используя прямые запросы к Telegram API
- Для получения количества участников в некоторых каналах могут потребоваться права администратора
- При большом количестве каналов сканирование может занять продолжительное время
- Сессия Telegram сохраняется автоматически после первого входа, последующие запуски не требуют повторной авторизации

## Лицензия

Проект создан в образовательных целях.
